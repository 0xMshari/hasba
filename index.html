<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>حاسبة التمويل العقاري</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script>tailwind.config = { darkMode: 'class' }</script>
    <style>
        body { font-family: 'Tajawal', sans-serif; transition: all 0.3s ease; touch-action: manipulation; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .active-tab { background-color: #2563eb !important; color: #ffffff !important; }
        .input-box { @apply bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700; border-width: 1px; border-radius: 12px; padding: 6px 10px; transition: all 0.2s ease; }
        /* تحسين شكل الزر المختار */
        .btn-active { @apply bg-blue-600 text-white border-blue-600 shadow-md ring-2 ring-blue-100 dark:ring-blue-900; }
        .btn-inactive { @apply bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-transparent hover:bg-slate-200; }
        @media (max-width: 768px) { .app-wrapper { border-radius: 0; } }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-950 min-h-screen flex items-center justify-center p-0 md:p-4">

    <div class="app-wrapper bg-white dark:bg-slate-900 w-full max-w-5xl md:rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col md:flex-row">
        
        <div class="inputs-area w-full md:w-[400px] bg-slate-50/50 dark:bg-slate-800/30 border-l border-slate-100 dark:border-slate-800 p-5 md:p-8 shrink-0">
            <h1 class="text-xl font-black text-blue-800 dark:text-blue-400 mb-6">حاسبة التمويل</h1>

            <div class="flex gap-1 p-1 bg-slate-200 dark:bg-slate-700 rounded-xl mb-6">
                <button onclick="setMode('manual')" id="btn-manual" class="flex-1 py-2 text-xs font-black rounded-lg transition-all">يدوي</button>
                <button onclick="setMode('offplan')" id="btn-offplan" class="flex-1 py-2 text-xs font-black rounded-lg transition-all">الخارطة</button>
                <button onclick="setMode('apartment')" id="btn-apartment" class="flex-1 py-2 text-xs font-black rounded-lg transition-all">الشقق</button>
            </div>

            <div class="space-y-4">
                <div id="apartment-options" class="hidden space-y-4">
                    <div class="grid grid-cols-2 gap-2">
                        <div class="input-box">
                            <label class="text-[10px] font-bold text-slate-500 block">القسم</label>
                            <select id="apt-section" onchange="updateAptList()" class="w-full bg-transparent outline-none font-bold text-sm dark:text-white">
                                <option value="">اختر</option>
                                <option value="A">القسم A</option>
                                <option value="B">القسم B</option>
                                <option value="C">القسم C</option>
                            </select>
                        </div>
                        <div class="input-box">
                            <label class="text-[10px] font-bold text-slate-500 block">الوحدة</label>
                            <select id="apt-unit" onchange="applyAptPrice()" class="w-full bg-transparent outline-none font-bold text-sm dark:text-white">
                                <option value="">اختر القسم</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="autoSetDown('10%')" id="btn-down-10" class="flex-1 py-2 text-[10px] font-bold rounded-lg border transition-all btn-inactive">دفعة 10%</button>
                        <button onclick="autoSetDown('100k')" id="btn-down-100k" class="flex-1 py-2 text-[10px] font-bold rounded-lg border transition-all btn-inactive">100 ألف</button>
                    </div>
                </div>

                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 block" id="price-label">قيمة العقار</label>
                    <div class="flex gap-2 items-center">
                        <div class="input-box flex-1">
                            <input type="text" id="price" oninput="formatInput(this);" class="w-full font-black text-lg outline-none bg-transparent dark:text-white">
                        </div>
                        <div id="ratio-selector" class="hidden flex flex-col gap-1 shrink-0">
                            <button onclick="setDiscount(1)" id="ltv-100" class="px-3 py-1 text-[10px] font-black rounded-md border border-slate-200 dark:text-white">100%</button>
                            <button onclick="setDiscount(0.95)" id="ltv-95" class="px-3 py-1 text-[10px] font-black rounded-md border border-slate-200 dark:text-white">95%</button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="input-box border-orange-100 bg-orange-50/30">
                        <label class="text-[10px] font-bold text-orange-600 block">العربون</label>
                        <input type="text" id="earnest" value="15,000" class="w-full font-bold text-md outline-none bg-transparent text-orange-700" oninput="formatInput(this)">
                    </div>
                    <div class="input-box">
                        <label class="text-[10px] font-bold text-slate-500 block">الدفعة</label>
                        <input type="text" id="down" value="0" oninput="formatInput(this); clearDownButtons();" class="w-full font-bold text-md outline-none bg-transparent dark:text-white">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="input-box">
                        <label class="text-[10px] font-bold text-slate-500 block">السنوات</label>
                        <input type="text" id="years" value="15" class="w-full font-bold text-md outline-none bg-transparent text-blue-700" oninput="formatInput(this)">
                    </div>
                    <div class="input-box">
                        <label class="text-[10px] font-bold text-slate-500 block">الفائدة (%)</label>
                        <input type="text" id="rate" value="3.55" oninput="formatInput(this, true)" class="w-full font-bold text-md outline-none bg-transparent dark:text-white">
                    </div>
                </div>
            </div>
        </div>

        <div class="results-area flex-1 p-6 md:p-12 bg-white dark:bg-slate-900 flex flex-col justify-center border-t md:border-t-0 md:border-r border-slate-100 dark:border-slate-800">
            <div class="mb-10 text-center md:text-right">
                <span class="inline-block text-[11px] font-black text-blue-600 bg-blue-50 dark:bg-blue-900/30 px-4 py-1.5 rounded-full mb-3 uppercase tracking-wider">القسط الشهري التقريبي</span>
                <div class="flex items-baseline justify-center md:justify-start gap-2">
                    <span id="monthly" class="text-6xl md:text-8xl font-black text-slate-900 dark:text-white tracking-tighter transition-all">0</span>
                    <span class="text-xl text-slate-400 font-bold">ريال</span>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div class="p-4 bg-slate-50 dark:bg-slate-800/50 rounded-2xl border border-slate-100 dark:border-slate-700">
                    <p class="text-slate-400 text-[10px] font-bold mb-1 uppercase">صافي التمويل</p>
                    <p class="text-2xl font-black text-slate-800 dark:text-slate-100" id="loan">0</p>
                </div>
                <div class="p-4 bg-blue-50/50 dark:bg-blue-900/20 rounded-2xl border border-blue-100/50 dark:border-blue-800">
                    <p class="text-blue-600 dark:text-blue-400 text-[10px] font-bold mb-1 uppercase">إجمالي الفوائد</p>
                    <p class="text-2xl font-black text-blue-900 dark:text-blue-100" id="interest">0</p>
                </div>
                <div class="p-6 bg-blue-600 dark:bg-blue-700 rounded-3xl text-white col-span-2 shadow-xl shadow-blue-200 dark:shadow-none mt-2">
                    <p class="text-blue-100 text-[10px] font-bold mb-1 uppercase opacity-80">إجمالي المديونية (القيمة الكلية)</p>
                    <p class="text-4xl font-black" id="total">0</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const apartments = [
            {id: "A30", sec: "A", price: 1097000}, {id: "A27", sec: "A", price: 909000}, {id: "A23", sec: "A", price: 809000},
            {id: "A21", sec: "A", price: 979000}, {id: "A28", sec: "A", price: 839000}, {id: "A11", sec: "A", price: 929000},
            {id: "A22", sec: "A", price: 929000}, {id: "A12", sec: "A", price: 859000}, {id: "A25", sec: "A", price: 897000},
            {id: "A24", sec: "A", price: 869000}, {id: "A26", sec: "A", price: 839000}, {id: "A13", sec: "A", price: 809000},
            {id: "A15", sec: "A", price: 789000}, {id: "A20", sec: "A", price: 819000}, {id: "A14", sec: "A", price: 779000},
            {id: "A18", sec: "A", price: 739000}, {id: "A19", sec: "A", price: 739000},
            {id: "B28", sec: "B", price: 869000}, {id: "B21", sec: "B", price: 869000}, {id: "B18", sec: "B", price: 919000},
            {id: "B20", sec: "B", price: 929000}, {id: "B22", sec: "B", price: 929000}, {id: "B19", sec: "B", price: 939000},
            {id: "B24", sec: "B", price: 979000}, {id: "B23", sec: "B", price: 989000}, {id: "B11", sec: "B", price: 819000},
            {id: "B25", sec: "B", price: 849000}, {id: "B16", sec: "B", price: 779000}, {id: "B17", sec: "B", price: 779000},
            {id: "C19", sec: "C", price: 739000}, {id: "C18", sec: "C", price: 749000}, {id: "C15", sec: "C", price: 779000},
            {id: "C20", sec: "C", price: 749000}, {id: "C24", sec: "C", price: 749000}, {id: "C14", sec: "C", price: 779000},
            {id: "C12", sec: "C", price: 929000}, {id: "C13", sec: "C", price: 929000}, {id: "C21", sec: "C", price: 929000},
            {id: "C23", sec: "C", price: 929000}, {id: "C25", sec: "C", price: 979000}, {id: "C22", sec: "C", price: 989000},
            {id: "C10", sec: "C", price: 1197000}, {id: "C11", sec: "C", price: 1197000}
        ];

        apartments.sort((a, b) => a.id.localeCompare(b.id, undefined, { numeric: true }));

        let currentMode = 'manual';
        let currentDiscount = 1; 
        let baseAptPrice = 0; 

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('apartment-options').classList.toggle('hidden', mode !== 'apartment');
            document.getElementById('ratio-selector').classList.toggle('hidden', mode !== 'apartment');
            document.getElementById('price-label').innerText = mode === 'apartment' ? 'قيمة العقار (بعد الخصم)' : 'قيمة العقار';

            ['manual', 'offplan', 'apartment'].forEach(m => {
                document.getElementById(`btn-${m}`).classList.toggle('active-tab', mode === m);
            });

            if (mode === 'apartment') {
                document.getElementById('rate').value = "3.75";
                document.getElementById('years').value = "20";
                setDiscount(1);
            }
            clearDownButtons();
            calculate();
        }

        function updateAptList() {
            const sec = document.getElementById('apt-section').value;
            const unitSelect = document.getElementById('apt-unit');
            unitSelect.innerHTML = '<option value="">الوحدة</option>';
            apartments.filter(a => a.sec === sec).forEach(a => {
                const opt = document.createElement('option');
                opt.value = a.price;
                opt.text = `${a.id} - (${a.price.toLocaleString()})`;
                unitSelect.add(opt);
            });
        }

        function applyAptPrice() {
            const price = document.getElementById('apt-unit').value;
            if (price) {
                baseAptPrice = Number(price);
                updatePriceField();
            }
        }

        function setDiscount(factor) {
            currentDiscount = factor;
            document.getElementById('ltv-100').className = factor === 1 ? 'px-3 py-1 text-[10px] font-black rounded-md bg-blue-600 text-white shadow-sm' : 'px-3 py-1 text-[10px] font-black rounded-md border border-slate-200 dark:text-white';
            document.getElementById('ltv-95').className = factor === 0.95 ? 'px-3 py-1 text-[10px] font-black rounded-md bg-blue-600 text-white shadow-sm' : 'px-3 py-1 text-[10px] font-black rounded-md border border-slate-200 dark:text-white';
            
            if (baseAptPrice > 0) updatePriceField();
        }

        function updatePriceField() {
            const discountedPrice = baseAptPrice * currentDiscount;
            document.getElementById('price').value = discountedPrice.toLocaleString();
            if(document.getElementById('btn-down-10').classList.contains('btn-active')) {
                autoSetDown('10%');
            }
            calculate();
        }

        function autoSetDown(type) {
            const price = getCleanVal('price');
            const downInput = document.getElementById('down');
            const btn10 = document.getElementById('btn-down-10');
            const btn100k = document.getElementById('btn-down-100k');

            if (type === '10%') {
                downInput.value = (price * 0.1).toLocaleString();
                btn10.className = "flex-1 py-2 text-[10px] font-bold rounded-lg border transition-all btn-active";
                btn100k.className = "flex-1 py-2 text-[10px] font-bold rounded-lg border transition-all btn-inactive";
            } else {
                downInput.value = (100000).toLocaleString();
                btn10.className = "flex-1 py-2 text-[10px] font-bold rounded-lg border transition-all btn-inactive";
                btn100k.className = "flex-1 py-2 text-[10px] font-bold rounded-lg border transition-all btn-active";
            }
            calculate();
        }

        function clearDownButtons() {
            document.getElementById('btn-down-10').className = "flex-1 py-2 text-[10px] font-bold rounded-lg border transition-all btn-inactive";
            document.getElementById('btn-down-100k').className = "flex-1 py-2 text-[10px] font-bold rounded-lg border transition-all btn-inactive";
        }

        function formatInput(el, isFloat = false) {
            let val = el.value.replace(isFloat ? /[^\d.]/g : /[^\d]/g, '');
            if (val === "") { el.value = ""; calculate(); return; }
            if (!isFloat) el.value = Number(val).toLocaleString('en-US');
            calculate();
        }

        function getCleanVal(id) { return Number(document.getElementById(id).value.replace(/,/g, '')) || 0; }

        function calculate() {
            let p = getCleanVal('price'), d = getCleanVal('down'), e = getCleanVal('earnest'), y = getCleanVal('years'), r = getCleanVal('rate') / 100;
            let loanAmount = Math.max(0, p - d - e);
            let totalInterest = loanAmount * r * y;
            let finalTotal = loanAmount + totalInterest;
            let monthly = (y > 0) ? (finalTotal / (y * 12)) : 0;
            const fmt = (n) => Math.max(0, n).toLocaleString('en-US', { maximumFractionDigits: 0 });
            document.getElementById('loan').innerText = fmt(loanAmount);
            document.getElementById('interest').innerText = fmt(totalInterest);
            document.getElementById('total').innerText = fmt(finalTotal);
            document.getElementById('monthly').innerText = fmt(monthly);
        }
        setMode('manual');
    </script>
</body>
</html>
